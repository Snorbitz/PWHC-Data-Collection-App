<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Women's Health Database &#8212; Data Entry Form</title>
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 14px;
      background: #f4f6f9;
      color: #2c3e50;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ── Left Navigation Sidebar ─────────────────────────────── */
    .app-layout {
      display: flex;
      flex: 1;
      min-height: 0;
    }

    .side-nav {
      width: 200px;
      flex-shrink: 0;
      background: #fff;
      border-right: 1px solid #e8e8f0;
      box-shadow: 2px 0 8px rgba(0, 0, 0, .06);
      display: flex;
      flex-direction: column;
      padding: 24px 0 32px;
      position: sticky;
      top: 0;
      height: calc(100vh - 84px);
      overflow-y: auto;
    }

    .side-nav .nav-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #aaa;
      padding: 0 20px 10px;
    }

    .side-nav a {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 11px 20px;
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      color: #555;
      border-left: 3px solid transparent;
      transition: background .15s, color .15s, border-color .15s;
    }

    .side-nav a:hover {
      background: #f9f4fc;
      color: #7b2d8b;
    }

    .side-nav a.active {
      background: #f3e8fb;
      color: #7b2d8b;
      border-left-color: #7b2d8b;
    }

    .side-nav a .nav-icon {
      font-size: 16px;
      width: 20px;
      text-align: center;
      flex-shrink: 0;
    }

    .main-content {
      flex: 1;
      min-width: 0;
      overflow-y: auto;
    }

    header {
      background: linear-gradient(135deg, #7b2d8b 0%, #c0396c 100%);
      color: #fff;
      padding: 20px 32px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .25);
    }

    header .logo {
      width: 46px;
      height: 46px;
      background: rgba(255, 255, 255, .2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
    }

    header h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: .3px;
    }

    header p {
      font-size: 12px;
      opacity: .85;
      margin-top: 2px;
    }

    .container {
      max-width: 1100px;
      margin: 28px auto;
      padding: 0 16px 40px;
    }

    .form-card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, .08);
      padding: 32px 36px;
    }

    .form-meta {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 16px;
      padding-bottom: 24px;
      margin-bottom: 4px;
    }

    h2.section-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .8px;
      color: #7b2d8b;
      font-weight: 700;
      margin: 28px 0 14px;
      padding-bottom: 6px;
      border-bottom: 1px solid #ede;
    }

    .fields-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px 28px;
    }

    .span2 {
      grid-column: span 2;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 12px 14px;
      background: #f8f5fa;
      /* Soft lavender background for visibility */
      border: 1px solid #efeff5;
      border-left: 4px solid #efeff5;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .field-group:focus-within {
      background: #fff;
      border-color: #d8c0e8;
      border-left-color: #7b2d8b;
      box-shadow: 0 4px 12px rgba(123, 45, 139, 0.05);
    }

    label {
      font-size: 13.5px;
      font-weight: 700;
      color: #6a2478;
      margin-bottom: 2px;
    }

    .req {
      color: #e63946;
      font-weight: 700;
      margin-left: 3px;
    }

    .hint {
      font-size: 11px;
      font-weight: 400;
      color: #888;
    }

    input[type="text"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 7px 10px;
      border: 1px solid #d0d0d8;
      border-radius: 6px;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 13px;
      color: #2c3e50;
      background: #fff;
      transition: border-color .15s, box-shadow .15s;
    }


    /* Staff Member should also fill its box as it is a single field in a row usually */
    #staff_member {
      flex: 1;
      min-height: 40px;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus {
      outline: none;
      border-color: #7b2d8b;
      box-shadow: 0 0 0 3px rgba(123, 45, 139, .12);
    }

    .search-filter {
      margin-bottom: 3px;
      background: #faf8fc;
    }

    select.multi-select {
      height: 130px;
    }

    select.multi-select.tall {
      height: 180px;
    }

    .select-wrap {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .form-actions {
      margin-top: 36px;
      display: flex;
      gap: 14px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 28px;
      border: none;
      border-radius: 6px;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s, transform .1s;
    }

    .btn:active {
      transform: scale(.98);
    }

    /* ── Branching Styles ── */
    .branch-container {
      margin-top: 10px;
      padding-left: 20px;
      border-left: 2px solid #e2d0f0;
      display: none;
    }

    .branch-container.active {
      display: block;
    }

    .category-checkbox-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }

    /* ── High-Level Hierarchy Styles ── */
    .tier-container {
      margin-bottom: 24px;
      padding: 16px;
      background: #fff;
      border: 1px solid #e8e8f0;
      border-radius: 10px;
    }

    .tier1-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
    }

    .tier-box {
      padding: 12px;
      background: #faf8fc;
      border: 1px solid #ede;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 13px;
    }

    .tier-box:hover {
      background: #f3e8fb;
      border-color: #d8c0e8;
    }

    .tier-box.active {
      background: #7b2d8b;
      color: #fff;
      border-color: #7b2d8b;
    }

    .tier2-area {
      margin-top: 20px;
      display: none;
      border-top: 1px solid #eee;
      padding-top: 15px;
    }

    .tier2-area.active {
      display: block;
    }

    .tier2-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 10px;
    }

    .tier3-area {
      margin-top: 15px;
      padding: 15px;
      background: #fcfaff;
      border: 1px dashed #d8c0e8;
      border-radius: 8px;
      display: none;
    }

    .tier3-area.active {
      display: block;
    }

    .tier3-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 8px;
    }

    .category-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 13px;
      line-height: 1.4;
      padding: 10px 12px;
      background: #faf8fc;
      border: 1px solid #ede;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s, box-shadow 0.2s;
    }

    .category-item:hover {
      background: #f3e8fb;
      border-color: #d8c0e8;
    }

    .category-item input {
      width: 17px;
      height: 17px;
      cursor: pointer;
      flex-shrink: 0;
      margin-top: -1px;
      /* Visual tweak for alignment with text top */
    }

    .btn-primary {
      background: linear-gradient(135deg, #7b2d8b, #c0396c);
      color: #fff;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #6a2279, #a8305e);
    }

    .btn-secondary {
      background: #f0e6f6;
      color: #7b2d8b;
    }

    .btn-secondary:hover {
      background: #e2d0f0;
    }

    #status-msg {
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 13px;
      display: none;
    }

    #status-msg.error {
      background: #fdecea;
      color: #c62828;
      border: 1px solid #ef9a9a;
      display: block;
    }

    /* ── Success toast (fixed, slides in from top) ── */
    #success-toast {
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #2e7d32, #43a047);
      color: #fff;
      padding: 16px 28px;
      border-radius: 10px;
      box-shadow: 0 6px 28px rgba(0, 0, 0, .22);
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 9999;
      transition: top .4s cubic-bezier(.22, 1, .36, 1), opacity .3s;
      opacity: 0;
      white-space: nowrap;
    }

    #success-toast.show {
      top: 28px;
      opacity: 1;
    }

    #success-toast .toast-icon {
      font-size: 22px;
      line-height: 1;
    }

    #success-toast .toast-sub {
      font-size: 12px;
      font-weight: 400;
      opacity: .85;
      margin-top: 2px;
    }

    .req {
      color: #c0396c;
      margin-left: 2px;
    }

    @media (max-width: 640px) {
      .form-card {
        padding: 20px 16px;
      }

      .form-meta {
        grid-template-columns: 1fr;
      }

      .fields-grid {
        grid-template-columns: 1fr;
      }

      .span2 {
        grid-column: span 1;
      }
    }
  </style>
</head>

<body>

  <header>
    <div class="logo">&#9792;</div>
    <div>
      <h1>Women&#39;s Health Database</h1>
      <p>Client Data Entry Form</p>
    </div>
  </header>

  <!-- SUCCESS TOAST -->
  <div id="success-toast" role="alert" aria-live="assertive">
    <span class="toast-icon">&#10003;</span>
    <div>
      <div>Record saved successfully!</div>
      <div class="toast-sub"></div>
    </div>
  </div>

  <div class="app-layout">

    <!-- LEFT NAVIGATION SIDEBAR -->
    <nav class="side-nav" aria-label="Application navigation">
      <div class="nav-label">Navigation</div>
      <a href="/" class="active" aria-current="page">
        <span class="nav-icon">&#9998;</span> Data Entry
      </a>
      <a href="/viewer">
        <span class="nav-icon">&#128203;</span> Record Viewer
      </a>
      <div style="flex-grow: 1;"></div>
      <a href="#" id="nav-btn-shutdown" style="color: #c62828;">
        <span class="nav-icon">&#9209;</span> Exit
      </a>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <div class="container">
        <div class="form-card">

          <h2 class="section-title">Session Information</h2>
          <div class="form-meta">
            <div class="field-group">
              <label for="session_date">Session Date <span class="req">*</span></label>
              <input type="date" id="session_date" name="session_date" required>
            </div>
            <div class="field-group">
              <label for="client_id">Client ID</label>
              <input type="text" id="client_id" name="client_id" placeholder="e.g. C-00123" autocomplete="off">
            </div>
            <div class="field-group">
              <label for="client_status">Client Status</label>
              <select id="client_status" name="client_status">
                <option value="New">New</option>
                <option value="Returning">Returning</option>
              </select>
            </div>
            <div class="field-group">
              <label for="staff_member">Staff Member</label>
              <input type="text" id="staff_member" name="staff_member" placeholder="e.g. Jane Doe" autocomplete="off">
            </div>

            <div class="field-group" id="visit_number_group" style="display: none;">
              <label for="visit_number">Visit Number</label>
              <input type="text" id="visit_number" name="visit_number" placeholder="e.g. 3" autocomplete="off">
            </div>

            <div class="field-group span2">
              <label>Practitioner <span class="hint">(Select category → role)</span></label>
              <div id="practitioner_t1" class="tier1-grid">
                <!-- Tier 1 will be generated here -->
              </div>

              <div id="practitioner_t2_container" class="tier2-area">
                <h3 style="font-size: 12px; margin-bottom: 10px; color: #7b2d8b;">Specific Practitioner Roles:</h3>
                <div id="practitioner_t2" class="tier2-grid"></div>
              </div>
              <!-- Hidden select for form data compatibility -->
              <select id="practitioner" name="practitioner" multiple style="display: none;"></select>
            </div>

          </div>

          <h2 class="section-title">Client Demographics</h2>
          <div class="fields-grid">

            <div class="field-group">
              <label for="age">Age</label>
              <select id="age" name="age">
                <option value="">-- Select --</option>
                <option value="0-15">0-15</option>
                <option value="16-19">16-19</option>
                <option value="20-24">20-24</option>
                <option value="25-29">25-29</option>
                <option value="30-34">30-34</option>
                <option value="35-39">35-39</option>
                <option value="40-44">40-44</option>
                <option value="45-49">45-49</option>
                <option value="50-54">50-54</option>
                <option value="55-59">55-59</option>
                <option value="60-64">60-64</option>
                <option value="65-69">65-69</option>
                <option value="70-74">70-74</option>
                <option value="75-79">75-79</option>
                <option value="80-84">80-84</option>
                <option value="85+">85+</option>
                <option value="&lt;Not Recorded&gt;">&lt;Not Recorded&gt;</option>
              </select>
            </div>

            <div class="field-group">
              <label for="country">Country of Birth</label>
              <input type="text" class="search-filter" placeholder="Search country..." data-target="country">
              <select id="country" name="country">
                <option value="">-- Select --</option>
              </select>
            </div>

            <div class="field-group">
              <label for="language">Language</label>
              <input type="text" class="search-filter" placeholder="Search language..." data-target="language">
              <select id="language" name="language">
                <option value="">-- Select --</option>
              </select>
            </div>

            <div class="field-group span2">
              <label>Ethnicity <span class="hint">(Select Major Group → Sub-Group → Specific Ethnicity)</span></label>
              <div id="ethnicity_t1" class="tier1-grid">
                <!-- Tier 1 will be generated here -->
              </div>

              <div id="ethnicity_t2_container" class="tier2-area">
                <h3 style="font-size: 12px; margin-bottom: 10px; color: #7b2d8b;">Sub-Groups:</h3>
                <div id="ethnicity_t2" class="tier2-grid"></div>
              </div>

              <div id="ethnicity_t3_container" class="tier3-area">
                <h3 id="ethnicity_t3_title" style="font-size: 12px; margin-bottom: 10px; color: #7b2d8b;">Specific
                  Ethnicities:</h3>
                <div id="ethnicity_t3" class="tier3-grid"></div>
              </div>

              <!-- Hidden select for form data compatibility -->
              <select id="ethnicity" name="ethnicity" multiple style="display: none;"></select>
            </div>

            <div class="field-group span2">
              <label>Visa Type <span class="hint">(Select category → visa subclass)</span></label>
              <div id="visa_type_t1" class="tier1-grid">
                <!-- Tier 1 will be generated here -->
              </div>

              <div id="visa_type_t2_container" class="tier2-area">
                <h3 style="font-size: 12px; margin-bottom: 10px; color: #7b2d8b;">Specific Visa Subclasses:</h3>
                <div id="visa_type_t2" class="tier2-grid"></div>
              </div>

              <!-- Hidden select for form data compatibility -->
              <select id="visa_type" name="visa_type" multiple style="display: none;"></select>
            </div>

            <div class="field-group">
              <label for="income_source">Income Source</label>
              <select id="income_source" name="income_source">
                <option value="">-- Select --</option>
                <option value="Wage/Salary">Wage/Salary</option>
                <option value="Sole Trader">Sole Trader</option>
                <option value="Pension, Benefit or Student Allowance">Pension, Benefit or Student Allowance</option>
                <option value="Personal Income">Personal Income</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="field-group">
              <label for="carer">Carer?</label>
              <select id="carer" name="carer">
                <option value="No" selected>No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>

            <div class="field-group">
              <label for="financial_hardship">Financial Hardship?</label>
              <select id="financial_hardship" name="financial_hardship">
                <option value="No" selected>No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>

            <div class="field-group">
              <label for="social_isolation">Social Isolation?</label>
              <select id="social_isolation" name="social_isolation">
                <option value="No" selected>No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>

            <div class="field-group">
              <label for="rural_postcode">Rural Postcodes?</label>
              <select id="rural_postcode" name="rural_postcode">
                <option value="No" selected>No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>

            <div class="field-group">
              <label for="lgbtiq">LGBTIQ+?</label>
              <select id="lgbtiq" name="lgbtiq">
                <option value="No" selected>No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>

          </div>

          <h2 class="section-title">Health &amp; Disability</h2>
          <div class="fields-grid">

            <div class="field-group">
              <label for="disability">Living with Disability</label>
              <div class="select-wrap">
                <input type="text" class="search-filter" placeholder="Filter..." data-target="disability">
                <select id="disability" name="disability" multiple class="multi-select">
                  <option value="Physical">Physical</option>
                  <option value="Sensory Impairment (vision/hearing)">Sensory Impairment (vision/hearing)</option>
                  <option value="Intellectual">Intellectual</option>
                  <option value="Mental health">Mental health</option>
                  <option value="Autoimmune">Autoimmune</option>
                  <option value="Metabolic">Metabolic</option>
                  <option value="Neurological">Neurological</option>
                  <option value="Genetic">Genetic</option>
                  <option value="Dermatological">Dermatological</option>
                  <option value="Chronic respiratory disease">Chronic respiratory disease</option>
                  <option value="Haematology/oncology">Haematology/oncology</option>
                  <option value="Gastroenterology">Gastroenterology</option>
                  <option value="Chronic End Stage">Chronic End Stage</option>
                  <option value="moderate to severe, multiple physical disability, major or permanent">moderate to
                    severe, multiple physical disability, major or permanent</option>
                  <option value="blindness, visual fields reduced, hearing loss">blindness, visual fields reduced,
                    hearing loss</option>
                  <option value="moderate severe or profound, learning, ADHD, Fragile X syndrome, IQ â55">moderate
                    severe or profound, learning, ADHD, Fragile X syndrome, IQ â55</option>
                  <option value="depression, anxiety, bipolar, schizophrenia">depression, anxiety, bipolar,
                    schizophrenia</option>
                  <option value="osteogenesis imperfecta, cystic fibrosis, polyarticular course juvenile arthritis">
                    osteogenesis imperfecta, cystic fibrosis, polyarticular course juvenile arthritis</option>
                  <option value="phenylketonuria, diabetes mellitus type 1">phenylketonuria, diabetes mellitus type 1
                  </option>
                  <option value="epilepsy, multiple sclerosis, autism">epilepsy, multiple sclerosis, autism</option>
                  <option value="chromosomal disorders, congenital, downs syndrome">chromosomal disorders, congenital,
                    downs syndrome</option>
                  <option value="atopic dermatitis (75%), significant burns">atopic dermatitis (75%), significant burns
                  </option>
                  <option value="oxygen required">oxygen required</option>
                  <option value="leukaemia, haemophillia">leukaemia, haemophillia</option>
                  <option value="final stage ulcerative colitis">final stage ulcerative colitis</option>
                  <option value="organ failure, organ transplant">organ failure, organ transplant</option>
                </select>
              </div>
            </div>

            <div class="field-group span2">
              <label>Chronic Illness <span class="hint">(Select category → illness)</span></label>
              <div id="chronic_illness_t1" class="tier1-grid">
                <!-- Tier 1 will be generated here -->
              </div>

              <div id="chronic_illness_t2_container" class="tier2-area">
                <h3 style="font-size: 12px; margin-bottom: 10px; color: #7b2d8b;">Specific Chronic Illnesses:</h3>
                <div id="chronic_illness_t2" class="tier2-grid"></div>
              </div>
              <!-- Hidden select for form data compatibility -->
              <select id="chronic_illness" name="chronic_illness" multiple style="display: none;"></select>
            </div>

          </div>

          <h2 class="section-title">Funding Stream</h2>
          <div class="fields-grid" id="funding-section">
            <div class="field-group">
              <label for="funding_stream">Funding Stream</label>
              <select id="funding_stream" name="funding_stream">
                <option value="">-- Select --</option>
                <option value="Health & Wellbeing">Health & Wellbeing</option>
                <option value="Safety & Empowerment">Safety & Empowerment</option>
              </select>
            </div>

            <div class="field-group" id="funding_option_group" style="visibility: hidden;">
              <label for="funding_option">Safety & Empowerment Option</label>
              <select id="funding_option" name="funding_option">
                <option value="">-- Select --</option>
                <option value="SHLV">SHLV</option>
                <option value="DVPass">DVPass</option>
                <option value="Frontline Worker">Frontline Worker</option>
                <option value="SHLV CW">SHLV CW</option>
              </select>
            </div>
          </div>

          <h2 class="section-title">Contact & Issues</h2>
          <div class="fields-grid">

            <div class="field-group">
              <label for="contact_mode">Contact Mode</label>
              <select id="contact_mode" name="contact_mode">
                <option value="">-- Select --</option>
                <option value="Attend Centre Appointment">Attend Centre Appointment</option>
                <option value="Attend Centre Group">Attend Centre Group</option>
                <option value="Drop In For Information">Drop In For Information</option>
                <option value="Drop In /Emergency">Drop In /Emergency</option>
                <option value="Outreach Clinic">Outreach Clinic</option>
                <option value="Outreach Group">Outreach Group</option>
                <option value="Telephone">Telephone</option>
                <option value="Letter">Letter</option>
                <option value="Email">Email</option>
                <option value="Online Website Contact Form">Online Website Contact Form</option>
                <option value="Home Visits">Home Visits</option>
                <option value="Outreach Appointment">Outreach Appointment</option>
                <option value="Telehealth">Telehealth</option>
                <option value="Audio Visual (E.g. Zoom, Skype)">Audio Visual (E.g. Zoom, Skype)</option>
                <option value="Social Media (E.g. Facebook, Twitter)">Social Media (E.g. Facebook, Twitter)</option>
                <option value="Online Chat / Forum">Online Chat / Forum</option>
                <option value="Other">Other</option>
                <option value="No Show/ Non-Attendance/ Cancelation">No Show/ Non-Attendance/ Cancelation</option>
                <option value="Text/SMS">Text/SMS</option>
                <option value="Community (out of centre)">Community (out of centre)</option>
                <option
                  value="Can be used identify client disengagement patterns that may require follow-up or additional support. Not intended to be reported to funding body.">
                  Can be used identify client disengagement patterns that may require follow-up or additional support.
                  Not intended to be reported to funding body.</option>
                <option
                  value="Reflects client support provided at events, when attending other organisations, or in the general public. Maybe most relevant to Aboriginal Access and Advocacy Workers.">
                  Reflects client support provided at events, when attending other organisations, or in the general
                  public. Maybe most relevant to Aboriginal Access and Advocacy Workers.</option>
              </select>
            </div>

            <div class="field-group span2">
              <label>Presenting Issues <span class="hint">(Select category → sub-category → issues)</span></label>
              <div id="presenting_issues_t1" class="tier1-grid">
                <!-- Tier 1 will be generated here -->
              </div>

              <div id="presenting_issues_t2_container" class="tier2-area">
                <h3 style="font-size: 12px; margin-bottom: 10px; color: #7b2d8b;">Sub-Categories:</h3>
                <div id="presenting_issues_t2" class="tier2-grid"></div>
              </div>

              <div id="presenting_issues_t3_container" class="tier3-area">
                <h3 id="t3_title" style="font-size: 12px; margin-bottom: 10px; color: #7b2d8b;">Specific Issues:</h3>
                <div id="presenting_issues_t3" class="tier3-grid"></div>
              </div>

              <!-- Hidden select for form data compatibility -->
              <select id="presenting_issues" name="presenting_issues" multiple style="display: none;"></select>
            </div>
          </div>

          <h2 class="section-title">Services Provided</h2>
          <div class="fields-grid" style="margin-bottom: 24px;">
            <div class="field-group span2">
              <label>Service Provided <span class="hint">(Select categories to reveal options)</span></label>
              <div id="service_provided_container" class="category-checkbox-list">
                <!-- Categories will be generated here -->
              </div>
              <div id="service_provided_branches">
                <!-- Branching options will be generated here -->
              </div>
              <!-- Hidden select for form data compatibility -->
              <select id="service_provided" name="service_provided" multiple style="display: none;"></select>
            </div>

            <div class="field-group span2">
              <label>Service Type <span class="hint">(Select category → specific type)</span></label>
              <div id="service_type_t1" class="tier1-grid">
                <!-- Tier 1 will be generated here -->
              </div>

              <div id="service_type_t2_container" class="tier2-area">
                <h3 style="font-size: 12px; margin-bottom: 10px; color: #7b2d8b;">Specific Service Types:</h3>
                <div id="service_type_t2" class="tier2-grid"></div>
              </div>
              <!-- Hidden select for form data compatibility -->
              <select id="service_type" name="service_type" multiple style="display: none;"></select>
            </div>

            <div class="field-group">
              <label for="group_type">Group Type</label>
              <div class="select-wrap">
                <select id="group_type" name="group_type" multiple class="multi-select">
                  <option value="Therapeutic">Therapeutic</option>
                  <option value="Health Education and Skills Development">Health Education and Skills Development
                  </option>
                  <option value="Support">Support</option>
                  <option value="Physical Activity">Physical Activity</option>
                  <option value="Social">Social</option>
                  <option value="Forums/Events">Forums/Events</option>
                  <option value="Capacity Building and Training for Other Services">Capacity Building and Training for
                    Other Services</option>
                </select>
              </div>
            </div>
          </div>

          <h2 class="section-title">Evaluation</h2>
          <div class="fields-grid">
            <div class="field-group">
              <label for="evaluation_tools">Evaluation Tools</label>
              <div class="select-wrap">
                <input type="text" class="search-filter" placeholder="Filter tools..." data-target="evaluation_tools">
                <select id="evaluation_tools" name="evaluation_tools" multiple class="multi-select">

                </select>
              </div>
            </div>

          </div>



          <div class="form-actions">
            <button type="button" class="btn btn-primary" id="submit-btn">Submit Record</button>
            <button type="button" class="btn btn-secondary" id="reset-btn">Clear Form</button>
            <span id="status-msg"></span>
          </div>

        </div>
      </div>

      <script>
        // Initialize live search/filter for select elements
        function initLiveSearch() {
          document.querySelectorAll('.search-filter').forEach(function (input) {
            var target = input.dataset.target;
            // Skip service_provided as it's now custom
            if (target === 'service_provided') return;
            var sel = document.getElementById(target);
            if (!sel) return;

            // Gather all options excluding the default placeholder unless it's a multiple select
            var allOptions = Array.from(sel.options).map(function (o) {
              return { value: o.value, text: o.text };
            }).filter(function (o) {
              return sel.multiple || o.value !== '';
            });

            // Remove old listener if we re-init
            var oldClone = input.cloneNode(true);
            input.parentNode.replaceChild(oldClone, input);
            var newInput = oldClone;

            newInput.addEventListener('input', function () {
              var q = newInput.value.toLowerCase().trim();
              var prev = new Set(Array.from(sel.selectedOptions).map(function (o) { return o.value; }));

              sel.innerHTML = '';
              if (!sel.multiple) {
                var def = document.createElement('option');
                def.value = ''; def.text = '-- Select --';
                sel.appendChild(def);
              }

              allOptions.forEach(function (opt) {
                if (!q || opt.text.toLowerCase().indexOf(q) !== -1) {
                  var el = document.createElement('option');
                  el.value = opt.value;
                  el.text = opt.text;
                  if (prev.has(opt.value)) el.selected = true;
                  sel.appendChild(el);
                }
              });
            });
          });
        }


        function setupChronicIllnessBranching(illnessData) {
          const t1Container = document.getElementById('chronic_illness_t1');
          const t2Container = document.getElementById('chronic_illness_t2');
          const t2Area = document.getElementById('chronic_illness_t2_container');
          const hiddenSelect = document.getElementById('chronic_illness');

          t1Container.innerHTML = '';
          t2Container.innerHTML = '';
          hiddenSelect.innerHTML = '';

          illnessData.forEach(cat => {
            const btn = document.createElement('div');
            btn.className = 'tier-box';
            btn.textContent = cat.tier1;
            t1Container.appendChild(btn);

            btn.addEventListener('click', () => {
              t1Container.querySelectorAll('.tier-box').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');

              t2Container.innerHTML = '';
              t2Area.classList.add('active');

              cat.tier2.forEach(illness => {
                const label = document.createElement('label');
                label.className = 'category-item';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.value = illness;

                if (Array.from(hiddenSelect.options).some(o => o.value === illness)) {
                  cb.checked = true;
                }

                label.appendChild(cb);
                label.appendChild(document.createTextNode(illness));
                t2Container.appendChild(label);

                cb.addEventListener('change', () => {
                  let existingOpt = Array.from(hiddenSelect.options).find(o => o.value === illness);
                  if (cb.checked) {
                    if (!existingOpt) {
                      existingOpt = document.createElement('option');
                      existingOpt.value = illness;
                      existingOpt.text = illness;
                      hiddenSelect.appendChild(existingOpt);
                    }
                    existingOpt.selected = true;
                  } else {
                    if (existingOpt) existingOpt.remove();
                  }
                });
              });
            });
          });
        }

        function setupVisaTypeBranching(visaData) {
          const t1Container = document.getElementById('visa_type_t1');
          const t2Container = document.getElementById('visa_type_t2');
          const t2Area = document.getElementById('visa_type_t2_container');
          const hiddenSelect = document.getElementById('visa_type');

          t1Container.innerHTML = '';
          t2Container.innerHTML = '';
          hiddenSelect.innerHTML = '';

          visaData.forEach(cat => {
            const btn = document.createElement('div');
            btn.className = 'tier-box';
            btn.textContent = cat.tier1;
            t1Container.appendChild(btn);

            btn.addEventListener('click', () => {
              t1Container.querySelectorAll('.tier-box').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');

              t2Container.innerHTML = '';
              t2Area.classList.add('active');

              cat.tier2.forEach(visa => {
                const label = document.createElement('label');
                label.className = 'category-item';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.value = visa;

                if (Array.from(hiddenSelect.options).some(o => o.value === visa)) {
                  cb.checked = true;
                }

                label.appendChild(cb);
                label.appendChild(document.createTextNode(visa));
                t2Container.appendChild(label);

                cb.addEventListener('change', () => {
                  let existingOpt = Array.from(hiddenSelect.options).find(o => o.value === visa);
                  if (cb.checked) {
                    if (!existingOpt) {
                      existingOpt = document.createElement('option');
                      existingOpt.value = visa;
                      existingOpt.text = visa;
                      hiddenSelect.appendChild(existingOpt);
                    }
                    existingOpt.selected = true;
                  } else {
                    if (existingOpt) existingOpt.remove();
                  }
                });
              });
            });
          });
        }

        function setupPresentingIssuesBranching(issuesData) {
          const t1Container = document.getElementById('presenting_issues_t1');
          const t2Container = document.getElementById('presenting_issues_t2');
          const t2Area = document.getElementById('presenting_issues_t2_container');
          const t3Container = document.getElementById('presenting_issues_t3');
          const t3Area = document.getElementById('presenting_issues_t3_container');
          const hiddenSelect = document.getElementById('presenting_issues');

          t1Container.innerHTML = '';
          t2Container.innerHTML = '';
          t3Container.innerHTML = '';
          hiddenSelect.innerHTML = '';

          issuesData.forEach(cat => {
            const btn = document.createElement('div');
            btn.className = 'tier-box';
            btn.textContent = cat.tier1;
            t1Container.appendChild(btn);

            btn.addEventListener('click', () => {
              // Toggle active class on T1 buttons
              t1Container.querySelectorAll('.tier-box').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');

              // Logic to show T2
              t2Container.innerHTML = '';
              t3Area.classList.remove('active');
              t2Area.classList.add('active');

              cat.tier2.forEach(sub => {
                const subBtn = document.createElement('div');
                subBtn.className = 'tier-box';
                subBtn.textContent = sub.name;
                t2Container.appendChild(subBtn);

                subBtn.addEventListener('click', () => {
                  t2Container.querySelectorAll('.tier-box').forEach(sb => sb.classList.remove('active'));
                  subBtn.classList.add('active');

                  // Logic to show T3
                  t3Container.innerHTML = '';
                  t3Area.classList.add('active');
                  document.getElementById('t3_title').textContent = sub.name + ' Issues:';

                  sub.tier3.forEach(issue => {
                    const label = document.createElement('label');
                    label.className = 'category-item';
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.value = issue;

                    // Check if already in hiddenSelect
                    if (Array.from(hiddenSelect.options).some(o => o.value === issue)) {
                      cb.checked = true;
                    }

                    label.appendChild(cb);
                    label.appendChild(document.createTextNode(issue));
                    t3Container.appendChild(label);

                    cb.addEventListener('change', () => {
                      let existingOpt = Array.from(hiddenSelect.options).find(o => o.value === issue);
                      if (cb.checked) {
                        if (!existingOpt) {
                          existingOpt = document.createElement('option');
                          existingOpt.value = issue;
                          existingOpt.text = issue;
                          hiddenSelect.appendChild(existingOpt);
                        }
                        existingOpt.selected = true;
                      } else {
                        if (existingOpt) existingOpt.remove();
                      }
                    });
                  });
                });
              });
            });
          });
        }

        function setupEthnicityBranching(ethnicityData) {
          const t1Container = document.getElementById('ethnicity_t1');
          const t2Container = document.getElementById('ethnicity_t2');
          const t2Area = document.getElementById('ethnicity_t2_container');
          const t3Container = document.getElementById('ethnicity_t3');
          const t3Area = document.getElementById('ethnicity_t3_container');
          const hiddenSelect = document.getElementById('ethnicity');

          t1Container.innerHTML = '';
          t2Container.innerHTML = '';
          t3Container.innerHTML = '';
          hiddenSelect.innerHTML = '';

          ethnicityData.forEach(cat => {
            const btn = document.createElement('div');
            btn.className = 'tier-box';
            btn.textContent = cat.tier1;
            t1Container.appendChild(btn);

            btn.addEventListener('click', () => {
              t1Container.querySelectorAll('.tier-box').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');

              t2Container.innerHTML = '';
              t3Area.classList.remove('active');
              t2Area.classList.add('active');

              cat.tier2.forEach(sub => {
                const subBtn = document.createElement('div');
                subBtn.className = 'tier-box';
                subBtn.textContent = sub.name;
                t2Container.appendChild(subBtn);

                subBtn.addEventListener('click', () => {
                  t2Container.querySelectorAll('.tier-box').forEach(sb => sb.classList.remove('active'));
                  subBtn.classList.add('active');

                  t3Container.innerHTML = '';
                  t3Area.classList.add('active');
                  document.getElementById('ethnicity_t3_title').textContent = sub.name + ' Ethnicities:';

                  sub.tier3.forEach(item => {
                    const label = document.createElement('label');
                    label.className = 'category-item';
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.value = item;

                    if (Array.from(hiddenSelect.options).some(o => o.value === item)) {
                      cb.checked = true;
                    }

                    label.appendChild(cb);
                    label.appendChild(document.createTextNode(item));
                    t3Container.appendChild(label);

                    cb.addEventListener('change', () => {
                      let existingOpt = Array.from(hiddenSelect.options).find(o => o.value === item);
                      if (cb.checked) {
                        if (!existingOpt) {
                          existingOpt = document.createElement('option');
                          existingOpt.value = item;
                          existingOpt.text = item;
                          hiddenSelect.appendChild(existingOpt);
                        }
                        existingOpt.selected = true;
                      } else {
                        if (existingOpt) existingOpt.remove();
                      }
                    });
                  });
                });
              });
            });
          });
        }

        function setupPractitionerBranching(practitionerData) {
          const t1Container = document.getElementById('practitioner_t1');
          const t2Container = document.getElementById('practitioner_t2');
          const t2Area = document.getElementById('practitioner_t2_container');
          const hiddenSelect = document.getElementById('practitioner');

          t1Container.innerHTML = '';
          t2Container.innerHTML = '';
          hiddenSelect.innerHTML = '';

          practitionerData.forEach(cat => {
            const btn = document.createElement('div');
            btn.className = 'tier-box';
            btn.textContent = cat.tier1;
            t1Container.appendChild(btn);

            btn.addEventListener('click', () => {
              t1Container.querySelectorAll('.tier-box').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');

              t2Container.innerHTML = '';
              t2Area.classList.add('active');

              cat.tier2.forEach(role => {
                const label = document.createElement('label');
                label.className = 'category-item';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.value = role;

                if (Array.from(hiddenSelect.options).some(o => o.value === role)) {
                  cb.checked = true;
                }

                label.appendChild(cb);
                label.appendChild(document.createTextNode(role));
                t2Container.appendChild(label);

                cb.addEventListener('change', () => {
                  let existingOpt = Array.from(hiddenSelect.options).find(o => o.value === role);
                  if (cb.checked) {
                    if (!existingOpt) {
                      existingOpt = document.createElement('option');
                      existingOpt.value = role;
                      existingOpt.text = role;
                      hiddenSelect.appendChild(existingOpt);
                    }
                    existingOpt.selected = true;
                  } else {
                    if (existingOpt) existingOpt.remove();
                  }
                });
              });
            });
          });
        }

        function setupServiceTypeBranching(serviceTypeData) {
          const t1Container = document.getElementById('service_type_t1');
          const t2Container = document.getElementById('service_type_t2');
          const t2Area = document.getElementById('service_type_t2_container');
          const hiddenSelect = document.getElementById('service_type');

          t1Container.innerHTML = '';
          t2Container.innerHTML = '';
          hiddenSelect.innerHTML = '';

          serviceTypeData.forEach(cat => {
            const btn = document.createElement('div');
            btn.className = 'tier-box';
            btn.textContent = cat.tier1;
            t1Container.appendChild(btn);

            btn.addEventListener('click', () => {
              t1Container.querySelectorAll('.tier-box').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');

              t2Container.innerHTML = '';
              t2Area.classList.add('active');

              cat.tier2.forEach(type => {
                const label = document.createElement('label');
                label.className = 'category-item';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.value = type;

                if (Array.from(hiddenSelect.options).some(o => o.value === type)) {
                  cb.checked = true;
                }

                label.appendChild(cb);
                label.appendChild(document.createTextNode(type));
                t2Container.appendChild(label);

                cb.addEventListener('change', () => {
                  let existingOpt = Array.from(hiddenSelect.options).find(o => o.value === type);
                  if (cb.checked) {
                    if (!existingOpt) {
                      existingOpt = document.createElement('option');
                      existingOpt.value = type;
                      existingOpt.text = type;
                      hiddenSelect.appendChild(existingOpt);
                    }
                    existingOpt.selected = true;
                  } else {
                    if (existingOpt) existingOpt.remove();
                  }
                });
              });
            });
          });
        }

        function setupServiceProvidedBranching(providedGroups) {
          const container = document.getElementById('service_provided_container');
          const branchesArea = document.getElementById('service_provided_branches');
          const hiddenSelect = document.getElementById('service_provided');

          container.innerHTML = '';
          branchesArea.innerHTML = '';
          hiddenSelect.innerHTML = '';

          providedGroups.forEach(g => {
            const cat = g.group;
            const options = g.options.map(o => o.value);

            // Category Checkbox
            const label = document.createElement('label');
            label.className = 'category-item';
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.dataset.category = cat;
            label.appendChild(cb);
            label.appendChild(document.createTextNode(cat));
            container.appendChild(label);

            // Branch Container
            const branchDiv = document.createElement('div');
            branchDiv.className = 'branch-container';
            branchDiv.id = 'branch-' + cat.replace(/\s+/g, '-').replace(/[^\w-]/g, '');

            const branchTitle = document.createElement('h3');
            branchTitle.style.fontSize = '12px';
            branchTitle.style.marginBottom = '8px';
            branchTitle.style.color = '#7b2d8b';
            branchTitle.textContent = cat + ' Options:';
            branchDiv.appendChild(branchTitle);

            const optionsGrid = document.createElement('div');
            optionsGrid.className = 'category-checkbox-list';

            options.forEach(val => {
              const optLabel = document.createElement('label');
              optLabel.className = 'category-item';
              const optCb = document.createElement('input');
              optCb.type = 'checkbox';
              optCb.value = val;
              optLabel.appendChild(optCb);
              optLabel.appendChild(document.createTextNode(val));
              optionsGrid.appendChild(optLabel);

              optCb.addEventListener('change', () => {
                let existingOpt = Array.from(hiddenSelect.options).find(o => o.value === val);
                if (optCb.checked) {
                  if (!existingOpt) {
                    existingOpt = document.createElement('option');
                    existingOpt.value = val;
                    existingOpt.text = val;
                    hiddenSelect.appendChild(existingOpt);
                  }
                  existingOpt.selected = true;
                } else {
                  if (existingOpt) existingOpt.remove();
                }
              });
            });

            branchDiv.appendChild(optionsGrid);
            branchesArea.appendChild(branchDiv);

            cb.addEventListener('change', () => {
              if (cb.checked) {
                branchDiv.classList.add('active');
              } else {
                branchDiv.classList.remove('active');
                branchDiv.querySelectorAll('input[type="checkbox"]').forEach(scb => {
                  scb.checked = false;
                  const opt = Array.from(hiddenSelect.options).find(o => o.value === scb.value);
                  if (opt) opt.remove();
                });
              }
            });
          });
        }

        // Load enormous option lists dynamically
        fetch('/api/options')
          .then(function (resp) { return resp.json(); })
          .then(function (data) {
            for (var selectId in data) {
              if (selectId === 'service_provided' || selectId === 'presenting_issues' || selectId === 'chronic_illness' || selectId === 'practitioner' || selectId === 'ethnicity' || selectId === 'service_type' || selectId === 'visa_type') continue; // Handled by specialized branching
              var sel = document.getElementById(selectId);
              if (!sel) continue;
              var opts = data[selectId];
              opts.forEach(function (o) {
                if (o.group) {
                  var optgroup = document.createElement('optgroup');
                  optgroup.label = o.group;
                  o.options.forEach(function (sub_o) {
                    var el = document.createElement('option');
                    el.value = sub_o.value;
                    el.text = sub_o.label;
                    optgroup.appendChild(el);
                  });
                  sel.appendChild(optgroup);
                } else {
                  var el = document.createElement('option');
                  el.value = o.value;
                  el.text = o.label;
                  sel.appendChild(el);
                }
              });
            }
            // Initialize live search AFTER options have loaded
            initLiveSearch();
            // Setup custom branching using the data directly from data.json
            setupServiceProvidedBranching(data.service_provided || []);
            setupPresentingIssuesBranching(data.presenting_issues || []);
            setupChronicIllnessBranching(data.chronic_illness || []);
            setupPractitionerBranching(data.practitioner || []);
            setupVisaTypeBranching(data.visa_type || []);
            setupServiceTypeBranching(data.service_type || []);
            setupEthnicityBranching(data.ethnicity || []);
          });

        // Funding Stream conditional logic
        document.getElementById('funding_stream').addEventListener('change', function (e) {
          var group = document.getElementById('funding_option_group');
          if (e.target.value === 'Safety & Empowerment') {
            group.style.visibility = 'visible';
          } else {
            group.style.visibility = 'hidden';
            document.getElementById('funding_option').value = '';
          }
        });

        // Toggle Visit Number visibility
        document.getElementById('client_status').addEventListener('change', function (e) {
          var group = document.getElementById('visit_number_group');
          if (e.target.value === 'Returning') {
            group.style.display = 'block';
          } else {
            group.style.display = 'none';
            document.getElementById('visit_number').value = '';
          }
        });

        // Collect form data
        function collectFormData() {
          var data = {};

          ['session_date', 'client_id', 'staff_member', 'client_status', 'visit_number', 'funding_stream', 'funding_option'].forEach(function (id) {
            var el = document.getElementById(id);
            if (el) data[id] = el.value.trim();
          });

          ['age', 'carer', 'financial_hardship', 'social_isolation', 'rural_postcode', 'lgbtiq', 'contact_mode', 'country', 'language', 'income_source'].forEach(function (id) {
            var el = document.getElementById(id);
            if (el) data[id] = el.value;
          });

          ['disability', 'chronic_illness', 'presenting_issues', 'service_provided',
            'service_type', 'practitioner', 'group_type', 'evaluation_tools', 'ethnicity', 'visa_type'].forEach(function (id) {
              var el = document.getElementById(id);
              if (el) data[id] = Array.from(el.selectedOptions).map(function (o) { return o.value; });
            });

          return data;
        }

        // ── Success toast helper ───────────────────────────────────────
        var toastTimer = null;
        function showSuccessToast(clientId, date) {
          var toast = document.getElementById('success-toast');
          var sub = toast.querySelector('.toast-sub');
          sub.textContent = (clientId ? clientId + '  |  ' : '') + (date || '');
          toast.classList.add('show');
          clearTimeout(toastTimer);
          toastTimer = setTimeout(function () {
            toast.classList.remove('show');
          }, 4000);
        }

        // ── Clear form helper (reuses reset logic) ─────────────────────
        function clearForm() {
          ['session_date', 'client_id', 'staff_member', 'client_status', 'visit_number', 'funding_stream', 'funding_option'].forEach(function (id) {
            var el = document.getElementById(id);
            if (el) el.value = '';
          });
          ['age', 'carer', 'financial_hardship', 'social_isolation', 'rural_postcode', 'lgbtiq', 'contact_mode', 'country', 'language', 'income_source'].forEach(function (id) {
            var el = document.getElementById(id);
            if (el) el.selectedIndex = 0;
          });
          ['disability', 'chronic_illness', 'presenting_issues', 'service_provided',
            'service_type', 'practitioner', 'group_type', 'evaluation_tools', 'ethnicity', 'visa_type'].forEach(function (id) {
              var el = document.getElementById(id);
              if (el) {
                Array.from(el.options).forEach(function (o) { o.selected = false; });
                if (id === 'service_provided' || id === 'visa_type') el.innerHTML = '';
              }
            });

          // Clear custom branching checkboxes
          document.querySelectorAll('#service_provided_container input, #service_provided_branches input, #presenting_issues_t3 input, #chronic_illness_t2 input, #practitioner_t2 input, #ethnicity_t3 input, #service_type_t2 input, #visa_type_t2 input').forEach(cb => cb.checked = false);
          document.querySelectorAll('.branch-container, .tier2-area, .tier3-area').forEach(bc => bc.classList.remove('active'));
          document.querySelectorAll('.tier-box').forEach(tb => tb.classList.remove('active'));

          document.querySelectorAll('.search-filter').forEach(function (inp) {
            inp.value = '';
            inp.dispatchEvent(new Event('input'));
          });
          var msg = document.getElementById('status-msg');
          msg.className = '';
          msg.style.display = 'none';
        }

        // ── Submit ────────────────────────────────────────────────────
        document.getElementById('submit-btn').addEventListener('click', function () {
          var msg = document.getElementById('status-msg');
          msg.className = '';
          msg.style.display = 'none';

          var data = collectFormData();

          if (!data.session_date) {
            msg.textContent = 'Please enter a session date before submitting.';
            msg.className = 'error';
            return;
          }

          var btn = document.getElementById('submit-btn');
          btn.disabled = true;
          btn.textContent = 'Saving...';

          fetch('/api/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          }).then(function (resp) {
            btn.disabled = false;
            btn.textContent = 'Submit Record';
            if (resp.ok) {
              showSuccessToast(data.client_id, data.session_date);
              clearForm();
            } else {
              return resp.text().then(function (err) {
                msg.textContent = 'Server error ' + resp.status + ': ' + (err || 'Unknown error');
                msg.className = 'error';
              });
            }
          }).catch(function (e) {
            btn.disabled = false;
            btn.textContent = 'Submit Record';
            msg.textContent = 'Network error: ' + e.message + '. Ensure the server is running.';
            msg.className = 'error';
          });
        });

        // Initialize toggle behavior for multi-selects
        ['disability', 'chronic_illness', 'presenting_issues', 'service_provided', 'service_type', 'practitioner', 'group_type', 'evaluation_tools'].forEach(function (id) {
          var sel = document.getElementById(id);
          if (sel) {
            sel.addEventListener('mousedown', function (e) {
              if (e.target.tagName === 'OPTION') {
                e.preventDefault();
                e.target.selected = !e.target.selected;
                // Focus the select and trigger change
                sel.focus();
                sel.dispatchEvent(new Event('change'));
              }
            });
          }
        });


        // Reset
        document.getElementById('reset-btn').addEventListener('click', function () {
          clearForm();
        });

        // Shutdown
        document.getElementById('nav-btn-shutdown').addEventListener('click', function (e) {
          e.preventDefault();
          if (confirm('Are you sure you want to shut down the server? You will need to run the launcher again to restart it.')) {
            fetch('/api/shutdown')
              .catch(function () { })
              .finally(function () {
                document.body.innerHTML = '<h2 style="padding: 40px; text-align: center; color: #555;">Server has been shut down. You may now close this tab.</h2>';
              });
          }
        });

      </script>
    </div><!-- /.container -->
  </div><!-- /.main-content -->
  </div><!-- /.app-layout -->
</body>

</html>